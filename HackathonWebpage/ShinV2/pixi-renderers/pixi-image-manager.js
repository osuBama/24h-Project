var gdjs;(function(u){const a=new u.Logger("PIXI Image manager"),T=(n,e)=>{a.error("Unable to load file "+n+" with error:",e||"(unknown error)")},d=(n,e)=>{!n||e.smoothed||(n.baseTexture.scaleMode=PIXI.SCALE_MODES.NEAREST)},g=(n,e)=>{e&&!e.smoothed&&(n.magFilter=THREE.NearestFilter,n.minFilter=THREE.NearestFilter)},c=["image","video"];class h{constructor(e){this._loadedTextures=new u.ResourceCache;this._getImageResource=e=>{const r=this._resourceLoader.getResource(e);return r&&this.getResourceKinds().includes(r.kind)?r:null};this._resourceLoader=e,this._invalidTexture=PIXI.Texture.from("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAFElEQVQoU2P8z/D/PwMewDgyFAAApMMX8Zi0uXAAAAAASUVORK5CYIIA"),this._loadedThreeTextures=new Hashtable,this._loadedThreeMaterials=new Hashtable}getResourceKinds(){return c}getPIXITexture(e){const r=this._getImageResource(e);if(!r)return a.warn('Unable to find texture for resource "'+e+'".'),this._invalidTexture;const i=this._loadedTextures.get(r);return i?i.valid?i:(a.error("Texture for "+e+" is not valid anymore (or never was)."),this._invalidTexture):this._invalidTexture}getOrLoadPIXITexture(e){const r=this._getImageResource(e);if(!r)return a.warn('Unable to find texture for resource "'+e+'".'),this._invalidTexture;const i=this._loadedTextures.get(r);if(i)return i.valid?i:(a.error("Texture for "+e+" is not valid anymore (or never was)."),this._invalidTexture);a.log('Loading texture for resource "'+e+'"...');const o=r.file,s=this._resourceLoader.getFullUrl(o),t=PIXI.Texture.from(s,{resourceOptions:{crossorigin:this._resourceLoader.checkIfCredentialsRequired(o)?"use-credentials":"anonymous"}}).on("error",l=>{T(o,l)});if(!t)throw new Error("Texture loading by PIXI returned nothing for file "+o+" behind url "+s);return d(t,r),this._loadedTextures.set(r,t),t}getThreeTexture(e){const r=this._loadedThreeTextures.get(e);if(r)return r;const i=this.getPIXITexture(e);if(!this._resourceLoader._runtimeGame.getRenderer().getPIXIRenderer())throw new Error("No PIXI renderer was found.");const s=i.baseTexture.resource.source;if(!(s instanceof HTMLImageElement))throw new Error(`Can't load texture for resource "${e}" as it's not an image.`);const t=new THREE.Texture(s);t.magFilter=THREE.LinearFilter,t.minFilter=THREE.LinearFilter,t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,t.colorSpace=THREE.SRGBColorSpace,t.needsUpdate=!0;const l=this._getImageResource(e);return g(t,l),this._loadedThreeTextures.put(e,t),t}getThreeMaterial(e,{useTransparentTexture:r,forceBasicMaterial:i}){const o=`${e}|${r?1:0}|${i?1:0}`,s=this._loadedThreeMaterials.get(o);if(s)return s;const t=i?new THREE.MeshBasicMaterial({map:this.getThreeTexture(e),side:r?THREE.DoubleSide:THREE.FrontSide,transparent:r}):new THREE.MeshStandardMaterial({map:this.getThreeTexture(e),side:r?THREE.DoubleSide:THREE.FrontSide,transparent:r,metalness:0});return this._loadedThreeMaterials.put(o,t),t}getPIXIVideoTexture(e){if(e==="")return this._invalidTexture;const r=this._getImageResource(e);if(!r)return a.warn('Unable to find video texture for resource "'+e+'".'),this._invalidTexture;const i=this._loadedTextures.get(r);return i||this._invalidTexture}getInvalidPIXITexture(){return this._invalidTexture}async loadResource(e){const r=this._resourceLoader.getResource(e);if(!r){a.warn('Unable to find texture for resource "'+e+'".');return}await this._loadTexture(r)}async processResource(e){}async _loadTexture(e){if(!this._loadedTextures.get(e))try{if(e.kind==="video")await new Promise((r,i)=>{const o=PIXI.Texture.from(this._resourceLoader.getFullUrl(e.file),{resourceOptions:{crossorigin:this._resourceLoader.checkIfCredentialsRequired(e.file)?"use-credentials":"anonymous",autoPlay:!1}}).on("error",t=>{i(t)});o.baseTexture.on("loaded",()=>{this._loadedTextures.set(e,o),d(o,e),r()})});else{const r=PIXI.Texture.from(this._resourceLoader.getFullUrl(e.file),{resourceOptions:{autoLoad:!1,crossorigin:this._resourceLoader.checkIfCredentialsRequired(e.file)?"use-credentials":"anonymous"}});await r.baseTexture.resource.load(),this._loadedTextures.set(e,r),d(r,e)}}catch(r){T(e.file,r)}}}u.PixiImageManager=h,u.ImageManager=u.PixiImageManager})(gdjs||(gdjs={}));
//# sourceMappingURL=pixi-image-manager.js.map
